name: Deploy Website

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create environment variables
        run: |
          # Create .env file for build process with all required variables
          cat > .env << 'EOF'
          # Supabase Configuration
          VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          
          # OneSignal Configuration
          VITE_ONESIGNAL_APP_ID=${{ secrets.VITE_ONESIGNAL_APP_ID }}
          
          # App Configuration
          VITE_APP_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/scheduler/
          
          # Build Configuration
          VITE_APP_TITLE=Port Arthur PD Scheduler
          VITE_APP_DESCRIPTION=Shift scheduling system for Port Arthur Police Department
          EOF
          
          echo "‚úÖ Environment file created"
          echo ""
          echo "üìã Environment variables set:"
          echo "  - VITE_SUPABASE_URL: ***"
          echo "  - VITE_SUPABASE_ANON_KEY: ***"
          echo "  - VITE_ONESIGNAL_APP_ID: ${{ secrets.VITE_ONESIGNAL_APP_ID }}"
          echo "  - VITE_APP_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/scheduler/"
          echo ""

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci
          echo "‚úÖ Dependencies installed"

      - name: Build site
        run: npm run build
        env:
          # Pass environment variables to the build process
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_ONESIGNAL_APP_ID: ${{ secrets.VITE_ONESIGNAL_APP_ID }}
          VITE_APP_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/scheduler/

      - name: Verify Build Output
        run: |
          echo "üîç Verifying build output..."
          echo ""
          
          echo "===== Basic File Check ====="
          if [ -d "dist" ]; then
            echo "‚úÖ dist/ directory exists"
            echo "üìä Size of dist/:"
            du -sh dist/
          else
            echo "‚ùå dist/ directory not found!"
            exit 1
          fi
          
          echo ""
          echo "===== Required Files Check ====="
          REQUIRED_FILES=("index.html" "assets/" "manifest.json" "sw.js")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -e "dist/$file" ]; then
              echo "‚úÖ dist/$file exists"
            else
              echo "‚ö†Ô∏è dist/$file not found"
            fi
          done

      - name: Verify OneSignal Configuration
        run: |
          echo "üöÄ Verifying OneSignal Configuration..."
          echo ""
          
          echo "===== OneSignal Script Check ====="
          if grep -q "OneSignalSDK.page.js" dist/index.html; then
            echo "‚úÖ OneSignal SDK script found in index.html"
          else
            echo "‚ùå OneSignal SDK script NOT found in index.html"
          fi
          
          echo ""
          echo "===== App ID Injection Check ====="
          # Check if placeholder was replaced
          if grep -q "%%ONESIGNAL_APP_ID%%" dist/index.html; then
            echo "‚ùå ERROR: Placeholder %%ONESIGNAL_APP_ID%% still exists in index.html!"
            echo "   The Vite plugin failed to inject the environment variable."
            echo ""
            echo "   First 5 lines containing 'appId':"
            grep -n "appId" dist/index.html | head -5
            exit 1
          else
            echo "‚úÖ No placeholders found in index.html"
          fi
          
          echo ""
          echo "===== Actual App ID Check ====="
          # Extract the actual App ID from the built HTML
          APP_ID_LINE=$(grep -o 'appId: "[^"]*"' dist/index.html | head -1)
          if [ -n "$APP_ID_LINE" ]; then
            APP_ID=$(echo "$APP_ID_LINE" | cut -d'"' -f2)
            echo "‚úÖ Found App ID in HTML: ${APP_ID:0:10}..."
            
            # Check if it matches the expected pattern
            if [[ "$APP_ID" == *"3417d840-c226-40ba-92d6-a7590c31eef3"* ]] || [[ "$APP_ID" == "${{ secrets.VITE_ONESIGNAL_APP_ID }}" ]]; then
              echo "‚úÖ App ID looks valid"
            else
              echo "‚ö†Ô∏è App ID doesn't match expected pattern"
            fi
          else
            echo "‚ùå Could not find appId in index.html"
          fi
          
          echo ""
          echo "===== Service Worker Path Check ====="
          if grep -q 'serviceWorkerPath: "/scheduler/OneSignalSDKWorker.js"' dist/index.html; then
            echo "‚úÖ Correct service worker path for GitHub Pages"
          else
            echo "‚ö†Ô∏è Service worker path may not be configured for /scheduler/ subdirectory"
            echo "   Checking for serviceWorkerPath in HTML:"
            grep -n "serviceWorker" dist/index.html || echo "   Not found"
          fi
          
          echo ""
          echo "===== Scope Check ====="
          if grep -q 'scope: "/scheduler/"' dist/index.html; then
            echo "‚úÖ Correct scope configured for /scheduler/"
          else
            echo "‚ö†Ô∏è Scope may not be configured correctly"
          fi

      - name: Create OneSignal Service Worker Files
        run: |
          echo "üîß Creating OneSignal service worker files..."
          echo ""
          
          # Create OneSignalSDKWorker.js in dist directory
          echo 'importScripts("https://cdn.onesignal.com/sdks/OneSignalSDKWorker.js");' > dist/OneSignalSDKWorker.js
          
          # Also create OneSignalSDKUpdaterWorker.js
          echo 'importScripts("https://cdn.onesignal.com/sdks/OneSignalSDKUpdaterWorker.js");' > dist/OneSignalSDKUpdaterWorker.js
          
          echo "‚úÖ Created service worker files:"
          ls -la dist/OneSignalSDKWorker.js dist/OneSignalSDKUpdaterWorker.js
          
          echo ""
          echo "üìã Content of OneSignalSDKWorker.js:"
          cat dist/OneSignalSDKWorker.js

      - name: Verify Service Worker Accessibility
        run: |
          echo "üåê Verifying service worker URLs..."
          echo ""
          
          # Calculate expected URLs
          REPO_NAME="${{ github.event.repository.name }}"
          OWNER_NAME="${{ github.repository_owner }}"
          BASE_URL="https://${OWNER_NAME}.github.io/${REPO_NAME}/scheduler"
          
          echo "Expected URLs after deployment:"
          echo "  - Main App: ${BASE_URL}/"
          echo "  - OneSignal Worker: ${BASE_URL}/OneSignalSDKWorker.js"
          echo "  - PWA Manifest: ${BASE_URL}/manifest.json"
          echo "  - PWA Service Worker: ${BASE_URL}/sw.js"
          echo ""
          
          echo "üìÅ Files that will be deployed:"
          find dist -type f -name "*.js" -o -name "*.json" -o -name "*.html" | sort | head -20

      - name: List build output
        run: |
          echo "===== Complete dist/ contents ====="
          find dist/ -type f | sort
          echo ""
          echo "===== File Count ====="
          find dist/ -type f | wc -l
          echo ""
          echo "===== Largest Files ====="
          find dist/ -type f -exec du -h {} + | sort -rh | head -10

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "Deploy: ${{ github.event.head_commit.message || 'Update' }}"

      - name: Deployment Verification
        if: always()
        run: |
          echo "üéâ Deployment completed!"
          echo ""
          echo "===== Next Steps ====="
          echo "1. Visit your site: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/scheduler/"
          echo "2. Open browser DevTools (F12)"
          echo "3. Check Console for errors"
          echo "4. Check Application ‚Üí Service Workers"
          echo "5. Look for 'OneSignal initialized' message"
          echo ""
          echo "===== OneSignal Testing ====="
          echo "To test OneSignal:"
          echo "1. Open the deployed site"
          echo "2. You should see a notification prompt after 3 seconds"
          echo "3. Click 'Allow Alerts'"
          echo "4. Check browser console for '‚úÖ Push notifications enabled'"
          echo "5. Test from OneSignal dashboard: https://app.onesignal.com"
          echo ""
          echo "===== Troubleshooting ====="
          echo "If OneSignal isn't working:"
          echo "1. Clear browser cache (Ctrl+Shift+R)"
          echo "2. Check Console for 404 errors"
          echo "3. Verify service worker is registered at /scheduler/ scope"
          echo "4. Ensure HTTPS is working (GitHub Pages provides this)"
