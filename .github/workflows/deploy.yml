name: Deploy Website

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create environment variables
        run: |
          # Create .env file for build process
          cat > .env << EOF
          VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_ONESIGNAL_APP_ID=${{ secrets.VITE_ONESIGNAL_APP_ID }}
          VITE_APP_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/scheduler/
          EOF
          
          echo "‚úÖ Environment file created"

      - name: Install dependencies
        run: |
          npm ci

      - name: Build site
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_ONESIGNAL_APP_ID: ${{ secrets.VITE_ONESIGNAL_APP_ID }}
          VITE_APP_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/scheduler/

      - name: Fix Service Worker Paths
        run: |
          echo "üîß Fixing service worker paths for GitHub Pages..."
          
          # Create OneSignal service worker files in dist root
          echo 'importScripts("https://cdn.onesignal.com/sdks/OneSignalSDKWorker.js");' > dist/OneSignalSDKWorker.js
          echo 'importScripts("https://cdn.onesignal.com/sdks/OneSignalSDKUpdaterWorker.js");' > dist/OneSignalSDKUpdaterWorker.js
          
          # Also create them in a scheduler directory for backup
          mkdir -p dist/scheduler
          echo 'importScripts("https://cdn.onesignal.com/sdks/OneSignalSDKWorker.js");' > dist/scheduler/OneSignalSDKWorker.js
          
          echo "‚úÖ Created service worker files in multiple locations"
          
          # Update manifest.json to use absolute paths
          if [ -f "dist/manifest.json" ]; then
            echo "üìù Updating manifest.json paths..."
            sed -i 's|"icons/|"/scheduler/icons/|g' dist/manifest.json
            echo "‚úÖ Updated manifest.json"
          fi
          
          # Create a test HTML to verify paths
          cat > dist/test-paths.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Path Test</title></head>
          <body>
            <h1>Service Worker Path Test</h1>
            <p>Testing if service workers are accessible:</p>
            <ul>
              <li><a href="/OneSignalSDKWorker.js">/OneSignalSDKWorker.js</a></li>
              <li><a href="/scheduler/OneSignalSDKWorker.js">/scheduler/OneSignalSDKWorker.js</a></li>
              <li><a href="/scheduler/manifest.json">/scheduler/manifest.json</a></li>
              <li><a href="/scheduler/sw.js">/scheduler/sw.js</a></li>
            </ul>
          </body>
          </html>
          EOF

      - name: Verify Deployment Structure
        run: |
          echo "üìÅ Final deployment structure:"
          echo ""
          echo "Root files:"
          ls -la dist/ | grep -E "(js|json|html|worker)" || true
          echo ""
          echo "scheduler/ directory files:"
          ls -la dist/scheduler/ 2>/dev/null || echo "No scheduler directory"
          echo ""
          echo "Service worker verification:"
          echo "OneSignalSDKWorker.js exists at root: $(test -f dist/OneSignalSDKWorker.js && echo '‚úÖ' || echo '‚ùå')"
          echo "OneSignalSDKWorker.js exists in scheduler: $(test -f dist/scheduler/OneSignalSDKWorker.js && echo '‚úÖ' || echo '‚ùå')"
          
          echo ""
          echo "üîç Checking index.html for correct paths:"
          grep -n "serviceWorker" dist/index.html || echo "No serviceWorker references"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Post-Deployment Test
        run: |
          echo "üåê Deployment completed!"
          echo ""
          echo "===== TEST YOUR DEPLOYMENT ====="
          echo ""
          echo "1. Open your deployed site:"
          echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/scheduler/"
          echo ""
          echo "2. Open browser DevTools (F12) and check:"
          echo "   - Console tab for errors"
          echo "   - Application ‚Üí Service Workers"
          echo "   - Network tab for 404 errors"
          echo ""
          echo "3. Test service worker URLs:"
          echo "   - https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/OneSignalSDKWorker.js"
          echo "   - https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/scheduler/OneSignalSDKWorker.js"
          echo ""
          echo "4. If still failing, try this workaround in browser console:"
          echo "   navigator.serviceWorker.register('/scheduler/OneSignalSDKWorker.js', { scope: '/scheduler/' })"
